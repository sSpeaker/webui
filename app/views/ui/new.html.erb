<html>
<head>



 <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
 <script src="http://code.jquery.com/jquery-migrate-1.1.0.min.js"></script>
 <script src="http://code.jquery.com/jquery-1.8.3.js"></script>
 <script src="http://code.jquery.com/ui/1.10.0/jquery-ui.js"></script>


<script>

function removeInput(divName, divName2) {
  document.getElementById("sortable").removeChild(document.getElementById(divName));
  document.getElementById("right").removeChild(document.getElementById(divName2));
}


$(document).ready(function(){
 //Resource title hilight 
  $(".resource_title").find(".link").live("click", function() {
    $('.resource_title').css('background-color','#F5F5DC');
    $(this).parents('.resource_title').css('background-color','#B0C4DE');
  });
 
 //Duplicate name field to title support
  $(".name").live("keyup",function() {
    var value = $(this).val();
    var count = $(this).data('counter');
    $("#parents_of_"+count).text(value);
  });
  
 //Selector support. TO DO
  $("#selector_img").live("click",function(){
    $(this).remove();
  });


 //Input rgexp check. ADD: Do not submit without valid regexp
  $(".regexp").live("keyup",function() {
    var value = $(this).val();
    var filter = new RegExp($(this).data('regexp'));

    //if it's valid
    if( filter.test(value)){
      $(this).removeClass("error");
      return true;
    }
    else{
      $(this).addClass("error");
      return false;
    }
  });

  $('#dynamicInput0 a.show_hide0').click(generateHandler(0));

  $('#sortable').sortable({
    update: function(event, ui) {
      var newOrder = $(this).sortable('toArray').toString();
      document.getElementById('sort').value = newOrder;
    }
  });
});

var counter = 1;

function generateHandler(number) {
  return function() {
    if ($('.slidingDiv' + number).css('display') == 'none') {
      for (var i = 0; i <= counter; i++) {
        if ((i != number) && ($('.slidingDiv' + i).css('display') != 'none')) {
          $('.slidingDiv' + i).slideToggle();
        }
      }
    }
    $('.slidingDiv' + number).slideToggle();
  };
}

function addInput(divName, type) {
  var mainCanvasDiv = document.createElement('div');
  mainCanvasDiv.id =  'right' + counter;
  mainCanvasDiv.className = 'slidingDiv' + counter;
  mainCanvasDiv.style.display = 'none';

  var newdiv = document.createElement('div');
  newdiv.id = 'dynamicInput_' + counter;
  newdiv.className = 'resource_title';

  switch (type)
  {
  <% @hash.each do |k,v| %>
    case '<%= k %>':
      newdiv.innerHTML = '<a href="#" class="link show_hide' + counter + '" onclick="generateHandler('+counter+')();light('+counter+')"><span><%= k.capitalize %>: </span><span id="parents_of_'+counter+'"></span></a>\
                          <a href="#" onclick=removeInput("'+newdiv.id+'","'+mainCanvasDiv.id+'")><img src="/assets/delete.png"></a><br>';

      mainCanvasDiv.innerHTML = '\
                                 <% v.each do |field_name,options| %>
                                   <% case options['type']
                                      when "select" %>
                                       <select name=="<%= k %>_<%= field_name %>_' + counter + '"><% options['values'].split(', ').each do |i| %><option><%= i %></option><% end %></select> <%= field_name %><br>\
                                     <% else %>
                                       <input type="text" id="input_<%= k %>_<%= field_name %>_' + counter + '" name="<%= k %>_<%= field_name %>_' + counter + '" \
                                       class="<%= "regexp " if options['regexp']%><%= "name " if field_name == "name" %>" \
                                       <%= 'data-regexp='+options['regexp']+'' if options['regexp'] %> \
                                       data-counter="' + counter + '" \
                                       <%= "required" if field_name == "name" or options['mandatory']%>>\
                                       <img id="selector_img" src="/assets/selector.png"> <%= field_name %><br>\
                                       <% end %>
                                    <% end %>';

    break;
  <% end %>
  }

  document.getElementById(divName).appendChild(newdiv);
  document.getElementById("right").appendChild(mainCanvasDiv);

  $('#dynamicInput_' + counter + ' show_hide' + counter).click(generateHandler(counter));

  counter++;
}

</script>

</head>
<body>
<form id="mainForm" action="/ui/download" method="POST" >
  <div id="center">
    <% @hash.each do |key,value| %>
      <input type="button" class="button" value="Add <%= key %>" onClick="addInput('sortable', '<%= key %>');"><br>
    <% end %>
  </div>

  <div id="left">
    <div id="sortable">
      <input type="hidden" name="sort" id="sort" value="">
    </div>
    <input type=submit value="Download!">
  </div>

  <div id="right">
  </div>

</form>
</body>
</html>


